<?php
include "baglan.php";

if (isset($_POST['action'])) {
    if ($_POST['action'] == 'fetchData') {
        $query = "SELECT * FROM meta";
        getData($query);
    }
    if ($_POST['action'] == 'searchRecord') {
        $searchKey = "%" . $_POST['searchKey'] . "%";
        $query = "SELECT * FROM meta WHERE meta_veri LIKE '$searchKey'";
        getData($query);
    }
}

function getData($query)
{
    global $dbh;
    $output = '';
    $stmContent = $dbh->prepare($query);
    $stmContent->execute();
    $content = $stmContent->fetchAll(PDO::FETCH_ASSOC);
    $totalContent = $stmContent->rowCount();

    if ($totalContent > 0) {
        foreach ($content as $key => $value) {
            $output .= '
            <div class="accordion-item mb-2">
            <span style="display:none;">' . $value["calisma_id"] . '</span>
                <h2 class="accordion-header text-start ps-2 py-2 bg-info-subtle border-top border-info-subtle fs-4 text-truncate"
                    id="flush-heading' . $value["calisma_id"] . '">
                    ' . htmlspecialchars($value["calisma"]) . '
                </h2>
                
                <div class="keys mt-2 mb-0" style="font-size: 0.5rem">
                    <span class="justify-content-center align-content-center mx-2 fw-bold" style="padding-bottom: 5px; flex: 0 0 auto">
                        Etiketler:
                    </span>
                    <div class="scroll-container">
                        <span class="scroll-item badge bg-secondary py-1 me-1">Öğe 1</span>
                        <span class="scroll-item badge bg-secondary py-1 me-1">Öğe 2</span>
                        <span class="scroll-item badge bg-secondary py-1 me-1">Öğe 3</span>
                        <span class="scroll-item badge bg-secondary py-1 me-1">Öğe 4</span>
                    </div>
                </div>
                
                <div class="d-flex align-items-center justify-content-between mx-2">
                    <div class="p-1 flex-grow-1 border-end trunc m-2">
                        ' . htmlspecialchars($value["meta_veri"]) . '
                    </div>
        
                    <div class="acord collapsed p-2 fw-lighter text-nowrap text-decoration-none text-center"
                        role="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse' . $value["calisma_id"] . '"
                        aria-expanded="false" aria-controls="flush-collapse' . $value["calisma_id"] . '">
                        <span></span>
                    </div>
                </div>
        
                <div id="flush-collapse' . $value["calisma_id"] . '" class="accordion-collapse collapse"
                    aria-labelledby="flush-heading' . $value["calisma_id"] . '" data-bs-parent="#accordionFlushExample">
                    <div class="accordion-body">
                        ' . htmlspecialchars($value["meta_veri"]) . '
                    </div>
                </div>
            </div>
        ';
        }
    } else {
        $output = '<h4>İlgili Kriterleri İçeren Çalışma Bulunamadı!</h4>';
    }
    echo $output;
}
